---
title: "Example Of Use With Dichotomous Outcome"
toc: true
bibliography: '`r system.file("references.bib", package="MiceExtVal")`' 
csl: '`r system.file("apa.csl", package="MiceExtVal")`'
vignette: >
  %\VignetteIndexEntry{Get Started Logistic Regression}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{gtsummary}
  %\VignetteDepends{kableExtra}
---

# Required Libraries

The following code snippet lists all the libraries needed to run this report.

```{r}
#| message: false
#| warning: false
#| code-fold: false
library(MiceExtVal)
library(gtsummary)
library(dplyr)
```

As an example of the use for logistic regression external validation we will replicate the external validation done by @steyerberg in the 20th chapter of his book. We validate the TIMI-II model represented in @tbl-timi-ii, see @timi-ii, among the GUSTO-I W region database, this data is already exported in the package as `MiceExtVal::gusto`. The model TIMI-II is a prediction model for patients with acute myocardial infarction. The TIMI-II model predicts the risk of death in 42 days of follow up while in the GUSTO-I W region cohort there is only 30-day follow-up. 

| Predictor      | Coefficient |
| :------------- | ----------: |
| Shock          |        1.79 |
| Age > 65       |        0.99 |
| High risk      |        0.92 |
| Diabetes       |        0.74 |
| Hypotension    |        0.69 |
| Tachycardia    |        0.59 |
| Time to relief |        0.53 |
| Sex            |        0.47 |
| Intercept      |       -4.47 |
:TIMI-II coefficients {#tbl-timi-ii .plain .table-sm}

# Explore the dataset

In the package we have included the GUSTO-I W region dataset that is used in @steyerberg book. To the book's original dataset we have introduced some missing data to be able to generate the external validation with a multiple imputed dataset.

```{r}
#| label: tbl-gusto-sum
#| tbl-cap: GUSTO-I W region dataset
#| classes: plain .table-sm
gusto <- MiceExtVal::gusto |> dplyr::mutate(id = dplyr::row_number())

gusto |>
  dplyr::mutate(
    sex = dplyr::case_when(
      sex == 0 ~ "Male", sex == 1 ~ "Female",
      .default = as.character(sex)
    )
  ) |>
  dplyr::select(-id) |>
  gtsummary::tbl_summary(
    by = "sex",
    missing_text = "% of missings",
    missing_stat = "{p_miss}%"
  )
```

# Impute Missing Data
To impute the missing data in the GUSTO-I W region dataset we will use the `mice` package, see @mice-package. In the next code snippet we impute the missing values and store them in a `long` dataset to be passed as argument to the `MiceExtVal` package.

```{r}
#| include: false
pred_matrix <- mice::make.predictorMatrix(gusto)
pred_matrix[, "id"] <- 0
gusto_imp <- mice::mice(gusto, predictorMatrix = pred_matrix) |>
  mice::complete("long")
```

```{r}
#| eval: false
pred_matrix <- mice::make.predictorMatrix(gusto)
pred_matrix[, "id"] <- 0
gusto_imp <- mice::mice(gusto, predictorMatrix = pred_matrix) |>
  mice::complete("long")
```

# External Validation
With the dataset already imputed we are ready to externally validate the model.

```{r}
timi2 <- MiceExtVal::mv_model_logreg(
  formula = day30 ~ 1.79 * sho + 0.99 * a65 + 0.92 * hig + 0.74 * dia +
    0.69 * hyp + 0.59 * hrt + 0.53 * ttr + 0.47 * sex - 4.47
)
```

```{r}
timi2 <- timi2 |>
  MiceExtVal::calculate_predictions(gusto_imp)
```

```{r}
timi2 <- timi2 |>
  MiceExtVal::calculate_predictions_recalibrated_type_1(gusto_imp) |>
  MiceExtVal::calculate_predictions_recalibrated_type_2(gusto_imp)
```

```{r}
#| layout-ncol: 3
timi2 |>
  MiceExtVal::get_calibration_plot_data_prop(
    model = _,
    data = gusto_imp,
    n_groups = 10,
    type = "predictions_aggregated"
  ) |>
  MiceExtVal::get_calibration_plot(data = _)

timi2 |>
  MiceExtVal::get_calibration_plot_data_prop(
    model = _,
    data = gusto_imp,
    n_groups = 10,
    type = "predictions_recal_type_1"
  ) |>
  MiceExtVal::get_calibration_plot(data = _)

timi2 |>
  MiceExtVal::get_calibration_plot_data_prop(
    model = _,
    data = gusto_imp,
    n_groups = 10,
    type = "predictions_recal_type_2"
  ) |>
  MiceExtVal::get_calibration_plot(data = _)
```


```{r}
timi2 <- timi2 |>
  MiceExtVal::calculate_auc(gusto_imp)
```
